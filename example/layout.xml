<layout>
    <if condition="exists(countdown)">
        <text x="100" y="100" font-name="DejaVu Sans" font-size="64" align="left"
              color="white" border-width="4" border-color="black"
              value="key(meta_name)" visible="eval(countdown<7.0)" />

        <timestamp x="130" y="200" align="left" font-name="DejaVu Sans" font-size="32"
                   color="white" border-color="black" border-width="2"
                   value="key(timestamp)" format="{:%Y-%m-%d}"
                   visible="eval(countdown<6.25)" timezone="Europe/Warsaw" />

        <text x="130" y="250" font-name="DejaVu Sans" font-size="32" align="left"
                color="white" border-width="2" border-color="black"
                value="eval(round(meta_distance/100)/10)" format="{:.1f} km"
                visible="eval(countdown<5.5)" />

        <text x="130" y="300" font-name="DejaVu Sans" font-size="32" align="left"
                color="white" border-width="2" border-color="black"
                value="eval(round(meta_ascent))" format="{:.0f} m"
                visible="eval(countdown<4.75)" />
    </if>

    <if condition="eval(overtime>2.0)">
        <text x="100" y="100" font-name="DejaVu Sans" font-size="64" align="left"
              color="white" border-width="4" border-color="black"
              value="key(meta_name)" />

        <text x="900" y="300" font-name="DejaVu Sans" font-size="64" align="right" color="white" border-width="4" border-color="black" value="Distance:" />
        <text x="900" y="400" font-name="DejaVu Sans" font-size="64" align="right" color="white" border-width="4" border-color="black" value="Time:" />
        <text x="900" y="500" font-name="DejaVu Sans" font-size="64" align="right" color="white" border-width="4" border-color="black" value="Ascent:" />
        <text x="900" y="600" font-name="DejaVu Sans" font-size="64" align="right" color="white" border-width="4" border-color="black" value="Max Grade:" />
        <text x="900" y="700" font-name="DejaVu Sans" font-size="64" align="right" color="white" border-width="4" border-color="black" value="Avg Speed:" />
        <text x="900" y="800" font-name="DejaVu Sans" font-size="64" align="right" color="white" border-width="4" border-color="black" value="Max Speed:" />

        <!-- TODO: add max power / avg power / normalized power -->
        <!-- TODO: add climb list? -->

        <text x="950" y="300" font-name="DejaVu Sans" font-size="64" align="left" color="white" border-width="4" border-color="black"
              value="eval(round(meta_distance/100)/10)" format="{:.1f} km" />
        <composite-text x="950" y="400" font-name="DejaVu Sans" font-size="64" align="left" color="white" border-width="4" border-color="black"
              value-1="eval(floor(meta_elapsedtime/3600))"
              value-2="eval(floor((meta_elapsedtime%3600)/60))"
              value-3="eval(meta_elapsedtime%60)"
              format="{:.0f}:{:02.0f}:{:06.3f}" />
        <text x="950" y="500" font-name="DejaVu Sans" font-size="64" align="left" color="white" border-width="4" border-color="black"
              value="eval(round(meta_ascent))" format="{:.0f} m" />
        <text x="950" y="600" font-name="DejaVu Sans" font-size="64" align="left" color="white" border-width="4" border-color="black"
              value="eval(meta_maxgrade)" format="{:.1f} %" />
        <text x="950" y="700" font-name="DejaVu Sans" font-size="64" align="left" color="white" border-width="4" border-color="black"
              value="eval(round(meta_avgspeed*36)/10)" format="{:.1f} km/h" />
        <text x="950" y="800" font-name="DejaVu Sans" font-size="64" align="left" color="white" border-width="4" border-color="black"
              value="eval(round(meta_maxspeed*36)/10)" format="{:.1f} km/h" />
    </if>

    <if condition="eval(time_elapsed>=0 and time_remaining>=0)"> <!-- FIXME key "active" doesnt work properly -->
        <timestamp x="10" y="10" align="left" font-name="DejaVu Sans" font-size="32"
                   color="white" border-color="black" border-width="2"
                   value="key(timestamp)" format="{:%Y-%m-%d %H:%M:%S}"
                   precision="0" timezone="Europe/Warsaw" />

        <composite-text x="550" y="10" align="left" font-name="DejaVu Sans" font-size="32"
              color="white" border-width="2" border-color="black"
              format="{:.0f}:{:02.0f}:{:06.3f}"
              value-1="eval(floor(time_elapsed/3600))"
              value-2="eval(floor((time_elapsed%3600)/60))"
              value-3="eval(time_elapsed%60)" />

        <!-- map & chart -->
        <container x="2990" y="50">
            <chart x="0" y="0" width="800" height="800" stretch-to-fill="false"
                   line-color="white" line-width="6"
                   point-color="red" point-size="14"
                   x-value="eval(1 + (point_lon / 180))"
                   y-value="eval(log(tan(((90 + point_lat) * 3.14159265359)/360))/3.14159265359)" />
            <chart x="0" y="850" width="800" height="100"
                   line-color="white" line-width="4"
                   point-color="red" point-size="12"
                   x-value="key(point_dist)"
                   y-value="key(point_smoothele)" />
        </container>

        <!-- moving charts -->

        <!-- speed moving chart -->
        <container x="720" y="1910">
            <rectangle x="0" y="0" width="600" height="204" color="#8c8c8c30" border-color="#fffffff0" border-width="2" />

            <chart x="0" y="2" width="600" height="200" line-color="white" line-width="4"
                   x-value="key(video_time)" y-value="key(pchip_point_speed)" value-time-step = "0.03"
                   filter-value="key(video_time)" filter-min="eval(video_time-15)" filter-max="key(video_time)"
                   zoom-to-filter-y="false"
                   min-x="eval(video_time-15)" max-x="eval(video_time)" />

            <text x="745" y="eval(187-200*pchip_point_speed/meta_maxspeed)" align="right"
                  font-name="DejaVu Sans" font-size="20" color="white" border-color="black" border-width="2"
                  value="eval(pchip_point_speed*3.6)" format="{:.1f} KM/H" />
        </container>

        <!-- power moving chart -->
        <container x="1620" y="1910">
            <rectangle x="0" y="0" width="600" height="204" color="#8c8c8c30" border-color="#fffffff0" border-width="2" />

            <chart x="0" y="2" width="600" height="200" line-color="white" line-width="4"
                   x-value="key(video_time)" y-value="key(pchip_point_power)" value-time-step = "0.03"
                   filter-value="key(video_time)" filter-min="eval(video_time-15)" filter-max="key(video_time)"
                   zoom-to-filter-y="false"
                   min-x="eval(video_time-15)" max-x="eval(video_time)"/>

            <text x="697" y="eval(187-200*pchip_point_power/meta_maxpower)" align="right"
                  font-name="DejaVu Sans" font-size="20" color="white" border-color="black" border-width="2"
                  value="eval(pchip_point_power)" format="{:.0f} W"  />
        </container>

        <!-- grade moving chart -->
        <container x="2520" y="1910">
            <rectangle x="0" y="0" width="600" height="204" color="#8c8c8c30" border-color="#fffffff0" border-width="2" />
            <line x="0" y="102" x2="600" y2="102" line-color="#fffffff0" line-width="2" />

            <chart x="0" y="2" width="600" height="200" line-color="white" line-width="4"
                   x-value="key(video_time)" y-value="key(pchip_point_grade)" value-time-step = "0.03"
                   filter-value="key(video_time)" filter-min="eval(video_time-15)" filter-max="key(video_time)"
                   min-x="eval(video_time-15)" max-x="eval(video_time)"
                   min-y="eval(-max(abs(meta_mingrade), abs(meta_maxgrade)))" max-y="eval(max(abs(meta_mingrade), abs(meta_maxgrade)))" />

            <text x="720" y="eval(187-(200*((pchip_point_grade + max(abs(meta_mingrade), abs(meta_maxgrade))) / (2 * max(abs(meta_mingrade), abs(meta_maxgrade))))))" align="right"
                  font-name="DejaVu Sans" font-size="20" color="white" border-color="black" border-width="2"
                  value="eval(pchip_point_grade)" format="{:.1f} %" />
        </container>

        <!-- left column -->
        <container x="230" y="1360">
            <container x="0" y="0">
            </container>
            <container x="0" y="150">
                <text x="0" y="0" align="right" font-name="DejaVu Sans" font-size="32" color="white" border-color="black" border-width="4" value="KM/H" />
                <if condition="exists(pchip_point_speed)">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="eval(pchip_point_speed*3.6)" format="{:.1f}" />
                </if>
                <if condition="not(exists(pchip_point_speed))">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="-" />
                </if>
            </container>
            <container x="0" y="300">
                <text x="0" y="0" align="right" font-name="DejaVu Sans" font-size="32" color="white" border-color="black" border-width="4" value="WATT" />
                <if condition="exists(pchip_point_power)">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="eval(pchip_point_power)" format="{:.0f}" />
                </if>
                <if condition="not(exists(pchip_point_power))">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="-" />
                </if>
            </container>
            <container x="0" y="450">
                <text x="0" y="0" align="right" font-name="DejaVu Sans" font-size="32" color="white" border-color="black" border-width="4" value="RPM" />
                <if condition="exists(pchip_point_cad)">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="eval(pchip_point_cad)" format="{:.0f}" />
                </if>
                <if condition="not(exists(pchip_point_cad))">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="-" />
                </if>
            </container>
            <container x="0" y="600">
                <text x="0" y="0" align="right" font-name="DejaVu Sans" font-size="32" color="white" border-color="black" border-width="4" value="GEAR" />
                <if condition="exists(point_rgearnum)">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="eval(point_rgearnum)" format="{:.0f}" />
                </if>
                <if condition="not(exists(point_rgearnum))">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="-" />
                </if>
            </container>
        </container>

        <!-- right column -->
        <container x="3770" y="1360">
            <container x="0" y="0">
            </container>
            <container x="0" y="150">
            </container>
            <container x="0" y="300">
            </container>
            <container x="0" y="450">
                <text x="0" y="0" align="right" font-name="DejaVu Sans" font-size="32" color="white" border-color="black" border-width="4" value="GRADE (%)" />
                <if condition="exists(pchip_point_grade)">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="eval(pchip_point_grade)" format="{:.1f}" />
                </if>
                <if condition="not(exists(pchip_point_grade))">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="-" />
                </if>
            </container>
            <container x="0" y="600">
                <text x="0" y="0" align="right" font-name="DejaVu Sans" font-size="32" color="white" border-color="black" border-width="4" value="KM" />
                <if condition="exists(pchip_point_dist)">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="eval(pchip_point_dist/1000)" format="{:.2f}" />
                </if>
                <if condition="not(exists(pchip_point_dist))">
                    <text x="0" y="38" align="right" font-name="DejaVu Sans" font-size="64" color="white" border-color="black" border-width="4" value="-" />
                </if>
            </container>
        </container>
    </if>
</layout>
